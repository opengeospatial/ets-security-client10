<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.7.1 at 2021-01-29 
 | Rendered using Apache Maven Fluido Skin 1.5
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20210129" />
    <meta http-equiv="Content-Language" content="en" />
    <title>OGC Web Service Security Client (OGC-17-007) Conformance Test Suite &#x2013; Testing with SAML2</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.5.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />

      
    <script type="text/javascript" src="./js/apache-maven-fluido-1.5.min.js"></script>

                      </head>
        <body class="topBarDisabled">
          
                
                    
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                    <a href="http://cite.opengeospatial.org/" id="bannerLeft">
                                                                                                <img src="./img/ogc-logo.png"  alt="OGC Web Service Security Client (OGC-17-007) Conformance Test Suite"/>
                </a>
                      </div>
        <div class="pull-right">  </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
              
                  <li id="publishDate">Last Published: 2021-01-29
                      <span class="divider">|</span>
                   </li>
                  <li id="projectVersion">Version: 0.6
                      </li>
                      
              
      
                                    
    <li class="pull-right">
                      <a href="https://github.com/opengeospatial/ets-security-client10/issues" class="externalLink" title="Issues">
        Issues</a>
      </li>

                    </ul>
      </div>

            
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
              
                <ul class="nav nav-list">
                    <li class="nav-header">Getting Started</li>
                              
      <li>
  
                          <a href="index.html" title="Overview">
          <span class="none"></span>
        Overview</a>
            </li>
                
      <li>
  
                          <a href="client_setup.html" title="Client Setup">
          <span class="none"></span>
        Client Setup</a>
            </li>
                
      <li class="active">
  
            <a href="#"><span class="none"></span>SAML2 Testing</a>
          </li>
                
      <li>
  
                          <a href="test_suite.html" title="Test Suite">
          <span class="none"></span>
        Test Suite</a>
            </li>
                
      <li>
  
                          <a href="team_setup.html" title="TEAM Engine Setup">
          <span class="none"></span>
        TEAM Engine Setup</a>
            </li>
                
      <li>
  
                          <a href="ca_cert_setup.html" title="CA Cert Setup">
          <span class="none"></span>
        CA Cert Setup</a>
            </li>
                
      <li>
  
                          <a href="changelog.html" title="Release Notes">
          <span class="none"></span>
        Release Notes</a>
            </li>
                              <li class="nav-header">Project Documentation</li>
                                                                                                  
      <li>
  
                          <a href="project-info.html" title="Project Information">
          <span class="icon-chevron-right"></span>
        Project Information</a>
                  </li>
                                                                  
      <li>
  
                          <a href="project-reports.html" title="Project Reports">
          <span class="icon-chevron-right"></span>
        Project Reports</a>
                  </li>
            </ul>
              
                
          <hr />

           <div id="poweredBy">
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />
      </a>
                  </div>
          </div>
        </div>
        
                
        <div id="bodyColumn"  class="span10" >
                                  
            <h1>Testing with SAML2</h1>
<p>For secure clients that want to test integration with SAML2 authentication, the test suite supports specifying a SAML2 metadata file URL that will use the SAML2 Browser SSO process. Authentication for the Identity Provider is assumed to be HTTP Basic Authentication; other authentication methods (such as X.509, HTTP form, Kerberos, etc) are beyond the scope of this guide.</p>
<p>The testing process is as follows:</p>

<ol style="list-style-type: decimal">
  
<li>The Secure Client connects to the Test Suite server, and issues a GET request for the partial capabilities</li>
  
<li>The Test Suite server responds with its partial capabilities document, that contains SAML2 metadata in its security annotations</li>
  
<li>The Secure Client issues a GET request for the complete capabilities document from the Test Suite server</li>
  
<li>The Test Suite server responds with a SAML Authentication redirect to the Identity Provider; the redirect URL contains additional parameters from the Test Suite server</li>
  
<li>The Secure Client loads the Identity Provider URL</li>
  
<li>The Identity Provider requires HTTP Basic authentication from the Secure Client, and responds with a <tt>401 Unauthorized</tt> response with the <tt>WWW-Authenticate</tt> header set to require HTTP Basic.</li>
  
<li>The Secure Client re-issues the GET request to the Identity Provider with the <tt>Authorization</tt> header set with valid HTTP Basic crendentials.</li>
  
<li>The Identity Provider identifies the Secure Client test user, and returns a base64-encoded SAMLResponse XML Document</li>
  
<li>The Secure Client sends a POST request to the Test Suite server with the SAMLResponse XML Document (encoded with base64, then URL encoded)</li>
  
<li>The Test Suite server validates the POST request, creates a security context for the test user, and returns the complete capabilities document, and ends the test session</li>
  
<li>The Test Suite then evaluates the requests from the Secure Client against the TestNG test methods</li>
</ol>
<p>This requires 5 requests from the Secure Client:</p>

<ol style="list-style-type: decimal">
  
<li>GET request for Service Provider partial capabilities</li>
  
<li>GET request for Service Provider complete capabilities</li>
  
<li>GET request for Identity Provider SSO</li>
  
<li>GET request for Identity Provider SSO with HTTP Basic credentials</li>
  
<li>POST request to Service Provider SSO URL with SAML Response</li>
</ol>
<p>In this case, the &#x201c;Service Provider&#x201d; is the executable test suite&#x2019;s embedded test server.</p>
<p>The Test Server will generate 3 responses for the Secure Client:</p>

<ol style="list-style-type: decimal">
  
<li>Respond with partial capabilities document containing security annotations</li>
  
<li>Respond with redirect to Identity Provider SSO with SAML Request query parameters</li>
  
<li>Respond with a cookie with security context, and return the complete capabilities</li>
</ol>
<div class="section">
<h2><a name="Detailed_Request_Procedure_WMS_1.1.1"></a>Detailed Request Procedure (WMS 1.1.1)</h2>
<div class="section">
<div class="section">
<h4><a name="Secure_Client:_Issue_GET_request_for_Capabilities"></a>Secure Client: Issue GET request for Capabilities</h4>

<div class="source">
<div class="source"><pre class="prettyprint">GET /aabbccddee HTTP/1.1
Accept: */*
Host: localhost:10080
</pre></div></div></div>
<div class="section">
<h4><a name="Test_Suite:_Respond_with_partial_Capabilities_document"></a>Test Suite: Respond with partial Capabilities document</h4>
<p>Capabilities document will have SAML2 constraint in the Vendor Specific Capabilities.</p>

<div class="source">
<div class="source"><pre class="prettyprint">HTTP/1.1 200 OK
Content-Type: application/vnd.ogc.wms_xml

&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&#x2026;
&lt;VendorSpecificCapabilities&gt;
  &lt;ows_security:ExtendedSecurityCapabilities xmlns:ows_security=&quot;http://www.opengis.net/security/1.0&quot;&gt;
    &lt;ows:OperationsMetadata xmlns:ows=&quot;http://www.opengis.net/ows/1.1&quot;&gt;
      &lt;ows:Operation name=&quot;GetCapabilities&quot;&gt;
        &lt;ows:DCP&gt;
          &lt;ows:HTTP&gt;
            &lt;ows:Get xmlns:xlink=&quot;http://www.w3.org/1999/xlink&quot; xlink:type=&quot;simple&quot; xlink:href=&quot;https://localhost:10080/aabbccddee/full&quot;&gt;
              &lt;ows:Constraint name=&quot;urn:ogc:def:security:1.0:rc:authentication:saml2&quot;&gt;
                  &lt;ows:ValuesReference ows:reference=&quot;https://idp.example.org/saml/sso&quot;/&gt;
              &lt;/ows:Constraint&gt;
            &lt;/ows:Get&gt;
            &lt;ows:Post xmlns:xlink=&quot;http://www.w3.org/1999/xlink&quot; xlink:type=&quot;simple&quot; xlink:href=&quot;https://localhost:10080/aabbccddee/full&quot;&gt;
              &lt;ows:Constraint name=&quot;urn:ogc:def:security:1.0:rc:authentication:saml2&quot;&gt;
                  &lt;ows:ValuesReference ows:reference=&quot;https://idp.example.org/saml/sso&quot;/&gt;
              &lt;/ows:Constraint&gt;
            &lt;/ows:Post&gt;
          &lt;/ows:HTTP&gt;
        &lt;/ows:DCP&gt;
      &lt;/ows:Operation&gt;
    &lt;/ows:OperationsMetadata&gt;
  &lt;/ows_security:ExtendedSecurityCapabilities&gt;
&lt;/VendorSpecificCapabilities&gt;
</pre></div></div></div>
<div class="section">
<h4><a name="Secure_Client:_Issue_GET_request_for_complete_Capabilities"></a>Secure Client: Issue GET request for complete Capabilities</h4>
<p>This is the URL defined in the <tt>&lt;ows:Get&gt;</tt> element.</p>

<div class="source">
<div class="source"><pre class="prettyprint">GET /aabbccddee/full HTTP/1.1
Accept: */*
Host: localhost:10080
</pre></div></div></div>
<div class="section">
<h4><a name="Test_Suite:_Respond_with_Redirect_to_Identity_Provider_SSO"></a>Test Suite: Respond with Redirect to Identity Provider SSO</h4>
<p>As the request for the complete capabilities does not include a security context (e.g. valid cookies), the test suite will redirect the test client to the IdP. In the <tt>Location</tt> header, the <tt>SAMLRequest</tt> query parameter will have the <a class="externalLink" href="https://en.wikipedia.org/wiki/SAML_2.0#SP_Redirect_Request;_IdP_POST_Response">SAML element</a>, and the <tt>RelayState</tt> query parameter will have a unique token for this test session. (Note that a real Service Provider would have its own secure method of generating and maintaining the RelayState token.)</p>

<div class="source">
<div class="source"><pre class="prettyprint">HTTP/1.1 302 Found
Location: https://idp.example.org/saml/sso/redirect?SAMLRequest=&lt;DATA&gt;&amp;RelayState=&lt;TOKEN&gt;
</pre></div></div></div>
<div class="section">
<h4><a name="Secure_Client:_Issue_GET_request_for_SSO_URL"></a>Secure Client: Issue GET request for SSO URL</h4>
<p>The Secure Client will load the URL from the test suite, connecting to the Identity Provider.</p>

<div class="source">
<div class="source"><pre class="prettyprint">GET /saml/sso/redirect?SAMLRequest=&lt;DATA&gt;&amp;RelayState=&lt;TOKEN&gt; HTTP/1.1
Accept: */*
Host: idp.example.org
</pre></div></div></div>
<div class="section">
<h4><a name="Identity_Provider:_Respond_with_Authorization_request"></a>Identity Provider: Respond with Authorization request</h4>
<p>The Identity Provider, configured for HTTP Basic, requests that type of authentication from the Secure Client by using the <tt>WWW-Authenticate</tt> header.</p>

<div class="source">
<div class="source"><pre class="prettyprint">HTTP/1.1 401 Unauthorized
WWW-Authenticate: Basic realm=&quot;SAML 2 Identity Provider&quot;
</pre></div></div></div>
<div class="section">
<h4><a name="Secure_Client:_Issue_GET_request_for_SSO_URL_with_credentials"></a>Secure Client: Issue GET request for SSO URL with credentials</h4>
<p>The Secure Client sends username and password to the Identity Provider using the <tt>Authorization</tt> header.</p>

<div class="source">
<div class="source"><pre class="prettyprint">GET /saml/sso/redirect?SAMLRequest=&lt;DATA&gt;&amp;RelayState=&lt;TOKEN&gt; HTTP/1.1
Accept: */*
Host: idp.example.org
Authorization: Basic &lt;base64 encoded credentials&gt;
</pre></div></div></div>
<div class="section">
<h4><a name="Identity_Provider:_Respond_with_SAML_Authentication_Response_Document"></a>Identity Provider: Respond with SAML Authentication Response Document</h4>
<p>The Identity Provider validates the credentials from the Secure Client, and responds with the SAML Authentication Response document, encoded with base64.</p>

<div class="source">
<div class="source"><pre class="prettyprint">HTTP/1.1 200 OK
Content-Type: text/xml

&lt;base64 encoded SAML Auth Response document&gt;
</pre></div></div></div>
<div class="section">
<h4><a name="Secure_Client:_Issue_POST_request_to_SAML_Callback_URL"></a>Secure Client: Issue POST request to SAML Callback URL</h4>
<p>The Authentication Response is received by the Secure Client and the base64 encoded string is then URL encoded and used as the <tt>RESPONSE</tt> parameter as a parameter to the Test Suite.</p>

<div class="source">
<div class="source"><pre class="prettyprint">POST /aabbccddee/saml2 HTTP/1.1
Accept: */*
Host: localhost:10080
Content-Type: application/x-www-form-urlencoded

SAMLResponse=&lt;RESPONSE&gt;&amp;RelayState=&lt;TOKEN&gt;
</pre></div></div></div>
<div class="section">
<h4><a name="Test_Suite:_Respond_with_Secure_Capabilities_with_a_Security_Context"></a>Test Suite: Respond with Secure Capabilities with a Security Context</h4>
<p>A Service Provider would normally validate the SAML Callback, but the Test Suite will accept anything. The Test Suite will create a cookie for the Secure Client to use, and that cookie will represent the security context. The <tt>Secure</tt> property for the cookie is not used as the Secure Client may be testing an HTTP-only workflow. The security context will be destroyed at the end of the test.</p>
<p>(It may be possible to support alternatives to cookies, such as JSON Web Tokens or HTTP Auth.)</p>

<div class="source">
<div class="source"><pre class="prettyprint">HTTP/1.1 200 Found
Set-Cookie: sessionToken=asdf11; Max-age=600; httpOnly
Content-Type: application/vnd.ogc.wms_xml

&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&#x2026;
</pre></div></div>
<p>This document will be the same as the partial capabilities document, except it now contains the Content section (for WMS, the &#x201c;Layer&#x201d; set of elements).</p>
<p>This is the final request in the workflow, so the Test Suite shuts down the embedded server and runs the TestNG test methods to validate the Secure Client behavior.</p></div></div></div>
<div class="section">
<h2><a name="Testing_the_Workflow"></a>Testing the Workflow</h2>
<p>A sample secure client that follows this workflow has been included in the <tt>scripts</tt> directory of the test suite repository. It will require you to manually set up your own Identity Provider and use its SSO callback URL as a test run property in the test suite. For more details, see the README in the scripts directory.</p></div>
                  </div>
            </div>
          </div>

    <hr/>

    <footer>
            <div class="container-fluid">
                      <div class="row-fluid">
                                      <p >Copyright &copy;                    2021
                        <a href="http://www.opengeospatial.org/">Open Geospatial Consortium</a>.
            All rights reserved.    
      </p>
                </div>

        
                </div>
    </footer>
        </body>
</html>