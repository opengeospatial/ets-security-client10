<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.7.1 at 2021-01-29 
 | Rendered using Apache Maven Fluido Skin 1.5
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20210129" />
    <meta http-equiv="Content-Language" content="en" />
    <title>OGC Web Service Security Client (OGC-17-007) Conformance Test Suite &#x2013; CA Certificate Setup</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.5.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />

      
    <script type="text/javascript" src="./js/apache-maven-fluido-1.5.min.js"></script>

                      </head>
        <body class="topBarDisabled">
          
                
                    
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                    <a href="http://cite.opengeospatial.org/" id="bannerLeft">
                                                                                                <img src="./img/ogc-logo.png"  alt="OGC Web Service Security Client (OGC-17-007) Conformance Test Suite"/>
                </a>
                      </div>
        <div class="pull-right">  </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
              
                  <li id="publishDate">Last Published: 2021-01-29
                      <span class="divider">|</span>
                   </li>
                  <li id="projectVersion">Version: 0.6
                      </li>
                      
              
      
                                    
    <li class="pull-right">
                      <a href="https://github.com/opengeospatial/ets-security-client10/issues" class="externalLink" title="Issues">
        Issues</a>
      </li>

                    </ul>
      </div>

            
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
              
                <ul class="nav nav-list">
                    <li class="nav-header">Getting Started</li>
                              
      <li>
  
                          <a href="index.html" title="Overview">
          <span class="none"></span>
        Overview</a>
            </li>
                
      <li>
  
                          <a href="client_setup.html" title="Client Setup">
          <span class="none"></span>
        Client Setup</a>
            </li>
                
      <li>
  
                          <a href="saml2.html" title="SAML2 Testing">
          <span class="none"></span>
        SAML2 Testing</a>
            </li>
                
      <li>
  
                          <a href="test_suite.html" title="Test Suite">
          <span class="none"></span>
        Test Suite</a>
            </li>
                
      <li>
  
                          <a href="team_setup.html" title="TEAM Engine Setup">
          <span class="none"></span>
        TEAM Engine Setup</a>
            </li>
                
      <li class="active">
  
            <a href="#"><span class="none"></span>CA Cert Setup</a>
          </li>
                
      <li>
  
                          <a href="changelog.html" title="Release Notes">
          <span class="none"></span>
        Release Notes</a>
            </li>
                              <li class="nav-header">Project Documentation</li>
                                                                                                  
      <li>
  
                          <a href="project-info.html" title="Project Information">
          <span class="icon-chevron-right"></span>
        Project Information</a>
                  </li>
                                                                  
      <li>
  
                          <a href="project-reports.html" title="Project Reports">
          <span class="icon-chevron-right"></span>
        Project Reports</a>
                  </li>
            </ul>
              
                
          <hr />

           <div id="poweredBy">
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />
      </a>
                  </div>
          </div>
        </div>
        
                
        <div id="bodyColumn"  class="span10" >
                                  
            <h1>CA Certificate Setup</h1>
<p>This guide will show how to use an HTTPS certificate from a trusted Certificate Authority (CA) with this ETS. It is assumed that you already have a running instance of TEAM Engine with ETS Security Client 1.0.</p>
<div class="section">
<h2><a name="Getting_a_Certificate"></a>Getting a Certificate</h2>
<p>If you have an internet-facing server, you can get a 100% free cert from <a class="externalLink" href="https://letsencrypt.org">Let&#x2019;s Encrypt</a>. It is a basic level cert, and lasts only 90 days. However there are simple tools available to automatically renew the cert before it expires.</p>
<p>In this example, I will set up a free certificate for the domain &#x201c;testbed.gswlab.ca&#x201d; with Tomcat 7 running on port 8080 (HTTP) and 8443 (HTTPS). The server is running Ubuntu Server 18.04 LTS.</p>
<p>I have already configured my DNS provider (AWS Route 53) with an <tt>A</tt> record to point <tt>testbed.gswlab.ca</tt> to the public-facing IPv4 address for this server. This is necessary for Let&#x2019;s Encrypt to verify ownership.</p>
<p>I will start by installing a newer version of <a class="externalLink" href="https://certbot.eff.org">certbot</a>:</p>

<div class="source">
<div class="source"><pre class="prettyprint">$ sudo apt-get update
$ sudo apt-get install software-properties-common
$ sudo add-apt-repository ppa:certbot/certbot
$ sudo apt-get update
$ sudo apt-get install certbot
</pre></div></div>
<p>As the machine is not running a web server on port 80, we can use certbot&#x2019;s built-in web server to validate the certificate for Let&#x2019;s Encrypt.</p>

<div class="source">
<div class="source"><pre class="prettyprint">$ sudo certbot certonly --standalone -d testbed.gswlab.ca --email jpbadger@ucalgary.ca --agree-tos --no-eff-email
</pre></div></div>
<p>This will create a directory with configuration files in <tt>/etc</tt>, containing all the certificates we need:</p>

<div class="source">
<div class="source"><pre class="prettyprint">$ ls /etc/letsencrypt/live/testbed.gswlab.ca
README  cert.pem  chain.pem  fullchain.pem  privkey.pem
</pre></div></div></div>
<div class="section">
<h2><a name="Setup_Certs_for_Tomcat"></a>Setup Certs for Tomcat</h2>
<p>Before Tomcat can use these certificates, they must be placed into a Java Keystore. Start by creating a PKCS12 file with the certs:</p>

<div class="source">
<div class="source"><pre class="prettyprint">$ sudo openssl pkcs12 -export -in /etc/letsencrypt/live/testbed.gswlab.ca/fullchain.pem -inkey /etc/letsencrypt/live/testbed.gswlab.ca/privkey.pem -out /etc/letsencrypt/live/testbed.gswlab.ca/full_and_key.p12 -password &quot;pass:secure-key-pass&quot; -name &quot;tomcat&quot;
$ sudo keytool -importkeystore -storetype JKS -deststorepass &quot;key-pass&quot; -destkeypass &quot;key-pass&quot; -destkeystore /opt/keystore.jks -srckeystore /etc/letsencrypt/live/testbed.gswlab.ca/full_and_key.p12 -srcstoretype PKCS12 -srcstorepass &quot;secure-key-pass&quot;
$ sudo chown tomcat7:tomcat7 /opt/keystore.jks
</pre></div></div>
<p>Substitute in your own randomly generated passwords for <tt>key-pass</tt> and <tt>secure-key-pass</tt>. <b>Please Note</b>: for the current version of the ETS, the keystore and key passwords must be the same.</p>
<p>Now you can edit Tomcat&#x2019;s <tt>server.xml</tt>, located at <tt>/etc/tomcat7/server.xml</tt> on Ubuntu, to specify the keystore for HTTPS:</p>

<div class="source">
<div class="source"><pre class="prettyprint">&lt;Connector port=&quot;8443&quot; protocol=&quot;org.apache.coyote.http11.Http11Protocol&quot; 
	URIEncoding=&quot;UTF-8&quot; maxThreads=&quot;150&quot; SSLEnabled=&quot;true&quot; scheme=&quot;https&quot; 
	secure=&quot;true&quot; clientAuth=&quot;false&quot; sslProtocol=&quot;TLS&quot; 
	keystoreFile=&quot;/opt/keystore.jks&quot; 
	keystorePass=&quot;key-pass&quot; keyAlias=&quot;tomcat&quot; keyPass=&quot;key-pass&quot; /&gt;
</pre></div></div>
<p>Add this under the Connector for port 8080, then restart Tomcat. The restart may take some time as it may generate random data for session IDs.</p>
<p>You should now be able to access the HTTPS version of Tomcat at <a class="externalLink" href="https://testbed.gswlab.ca:8443/">https://testbed.gswlab.ca:8443/</a>.</p></div>
<div class="section">
<h2><a name="Automatically_Update_the_Keystore"></a>Automatically Update the Keystore</h2>
<p>As the Let&#x2019;s Encrypt certificate expires every 90 days, cerbot has created a cron daemon entry in <tt>/etc/cron.d/certbot</tt> to automatically renew the certificate without our intervention. Unfortunately that only updates the PEM files, not the Java Keystore.</p>
<p>To fix this, we will add a post-renew hook script to automatically update the keystore. Create a new script file in <tt>/etc/letsencrypt/renewal-hooks/post/tomcat</tt> with the following contents:</p>

<div class="source">
<div class="source"><pre class="prettyprint">#!/bin/bash
set -e

openssl pkcs12 -export -in /etc/letsencrypt/live/testbed.gswlab.ca/fullchain.pem \
	-inkey /etc/letsencrypt/live/testbed.gswlab.ca/privkey.pem \
	-out /etc/letsencrypt/live/testbed.gswlab.ca/full_and_key.p12 \
	-password &quot;pass:secure-key-pass&quot; -name &quot;tomcat&quot;

keytool -importkeystore -storetype JKS -deststorepass &quot;key-pass&quot; \
	-destkeypass &quot;key-pass&quot; -destkeystore /opt/keystore.jks \
	-srckeystore /etc/letsencrypt/live/testbed.gswlab.ca/full_and_key.p12 \
	-srcstoretype PKCS12 -srcstorepass &quot;secure-key-pass&quot;

chown tomcat7:tomcat7 /opt/keystore.jks
systemctl reload-or-restart tomcat7
</pre></div></div>
<p>Again, update the passwords with your secure versions. After saving the script, make it executable:</p>

<div class="source">
<div class="source"><pre class="prettyprint">$ sudo chmod +x /etc/letsencrypt/renewal-hooks/post/tomcat
</pre></div></div>
<p>Now after certbot renews the PEM certs, it will update the Keystore for Tomcat too.</p></div>
<div class="section">
<h2><a name="Set_up_the_ETS_with_the_Keystore"></a>Set up the ETS with the Keystore</h2>
<p>After making sure that Tomcat works with HTTPS and has TEAM Engine installed, we must customize the CTL script for Security Client 1.0 to support our keystore.</p>
<p>Edit the file <tt>/opt/te_base/scripts/security-client10/1.0/ctl/security-client10-suite.ctl</tt>, and change the text contents of the following <tt>&lt;xsl:variable&gt;</tt> elements:</p>

<ul>
  
<li><tt>address</tt> should stay as <tt>0.0.0.0</tt></li>
  
<li><tt>port</tt> can stay as <tt>10080</tt></li>
  
<li><tt>host</tt> should be the same as the domain used in the certificate</li>
  
<li><tt>jks_path</tt> should be changed to <tt>/opt/keystore.jks</tt></li>
  
<li><tt>jks_password</tt> should be changed to <tt>&lt;!CDATA[key-pass]]</tt></li>
</ul>
<p>Using CDATA is recommended for the password, especially if your password contains special characters that may be incorrectly interpreted as XML. <b>If you password contains <tt>]]</tt></b> then you will have to escape that portion of the password.</p>
<p>After saving the file, restart Tomcat. Login to TEAM Engine, and create a new test session for ETS Security Client 1.0. After starting a test session, it should give you an endpoint with the format:</p>
<p><tt>https://0.0.0.0:10080/&lt;nonce&gt;</tt></p>
<p>On your secure client, you should be able to use <tt>https://testbed.gswlab.ca:10080/&lt;nonce&gt;</tt> instead, <b>and</b> you should not need to disable certificate verification.</p></div>
                  </div>
            </div>
          </div>

    <hr/>

    <footer>
            <div class="container-fluid">
                      <div class="row-fluid">
                                      <p >Copyright &copy;                    2021
                        <a href="http://www.opengeospatial.org/">Open Geospatial Consortium</a>.
            All rights reserved.    
      </p>
                </div>

        
                </div>
    </footer>
        </body>
</html>